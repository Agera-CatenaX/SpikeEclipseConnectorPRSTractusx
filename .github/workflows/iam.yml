name: IAM

on: 
  push:
    paths:
      # This is where IAM related scripts and manifests reside
      - 'coreservices/iam/**'
      # this workflow file
      - '.github/workflows/iam.yml'
    branches:
      # Integration environment
      - main
      # DevOps and IAM Dev Space
      - feature/CAX-12-devops
      # Temporarily: DevOps Dev Space IAM Features
      - feature/CAX-12-devops@CXMVP-117-IAM
      # ADAPT HERE TO ADD NEW WORKSPACES

jobs:
  ########################################
  # First job to determine the environment
  ########################################

  environment:
    name: Determine Target Environment
    runs-on: ubuntu-latest
    outputs:
      workspace: ${{ steps.setvars.outputs.workspace }}
      issuer: ${{ steps.setvars.outputs.issuer }}

    steps:
      - name: Set variables
        id: setvars
        run: |
          if [[ "${{github.repository}}" == eclipse/tractusx ]]; then
             if [[ "${{github.ref}}" == refs/heads/main ]]; then
                echo "Determined PRODUCTION"
                echo "::set-output name=workspace::prod"
                echo "::set-output name=issuer::prod"
             else
                echo "Unsupported Environment on ECLIPSE. Leaving Workspace empty."
             fi
          else 
            if [[ "${{github.repository}}" == catenax/tractusx ]]; then
              if [[ "${{github.ref}}" == refs/heads/main ]]; then
                echo "Determined INTEGRATION"
                echo "::set-output name=workspace::int"
                echo "::set-output name=issuer::staging"
              elif [[ "${{github.ref}}" = refs/heads/feature/CAX-1-semantics || "${{github.ref}}" = refs/heads/feature/CAX-1-semantics@CXMVP-63-semantic-architecture ]]; then
                  echo "Determined SEMANTICS"
                  echo "::set-output name=workspace::dev042"
                  echo "::set-output name=issuer::staging"
              elif [[ "${{github.ref}}" = refs/heads/feature/CAX-12-devops || "${{github.ref}}" = refs/heads/feature/CAX-12-devops@CXMVP-117-IAM ]]; then
                  echo "Determined DEVOPS"
                  echo "::set-output name=workspace::dev003"
                  echo "::set-output name=issuer::staging"
              else 
                  echo "Unsupported Branch on CATENAX. Leaving Workspace empty."
              fi
            else
                echo "Unsupported Environment/Repository. Leaving Workspace empty."
            fi
          fi

  deploy:
    runs-on: ubuntu-latest
    # rely on the first job
    needs: environment
    # rely on successful detection of the workspace, ignore if empty
    if: ${{needs.environment.outputs.workspace}}
    env:
      WORKSPACE: ${{needs.environment.outputs.workspace}}
      CLUSTER_ISSUER: ${{needs.environment.outputs.issuer}}
      CATENA_SERVICE_URL: https://catenax${{needs.environment.outputs.workspace}}akssrv.germanywestcentral.cloudapp.azure.com/
      CATENA_SERVICE_HOST: catenax${{needs.environment.outputs.workspace}}akssrv.germanywestcentral.cloudapp.azure.com

    steps:
      - name: Login via Azure CLI
        uses: azure/login@v1
        with:
          creds: ${{secrets.AZURE_CREDENTIALS}}

      # get the latest sources
      - name: Checkout
        uses: actions/checkout@v2

      # Login to AKS
      - name: Kubernetes Login
        uses: azure/aks-set-context@v1
        with:
          creds: '${{secrets.AZURE_CREDENTIALS}}'
          resource-group: 'catenax-${{needs.environment.outputs.workspace}}-rg'
          cluster-name: 'catenax-${{needs.environment.outputs.workspace}}-aks-services'
        id: login

      # Deploy IAM service
      - name: IAM service deployment on AKS
        working-directory: ./infrastructure/manifests        
        run: |
          cat iam.yaml | envsubst | kubectl apply -f - 

      # Deploy IAM ingress
      - name: IAM ingress deployment on AKS
        working-directory: ./infrastructure/manifests        
        run: |
          cat iam-ingress.yaml | envsubst | kubectl apply -f -
